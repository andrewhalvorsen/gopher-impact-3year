<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smokin’ Burrow – Rodent Impact Estimator (3-Year)</title>
<style>
  :root{ --yellow:#f4cf2f; --ink:#0f172a; --border:#e5e7eb; --bg:#f8fafc; --card:#ffffff; --radius:20px; --shadow:0 18px 40px rgba(0,0,0,.08); }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }
  .wrap{ max-width:1320px; margin:48px auto; padding:0 20px; display:grid; grid-template-columns:440px 1fr; gap:28px; }
  .panel{ border-radius:var(--radius); box-shadow:var(--shadow); }
  .left{ background:var(--yellow); padding:32px 26px; display:flex; flex-direction:column; gap:26px; }
  .right{ background:var(--card); padding:28px 26px; }

  .lead h1{ margin:0; font-size:28px; line-height:1.15; letter-spacing:-0.01em; }
  .group{ display:flex; flex-direction:column; gap:12px; }
  .label{ font-weight:800; font-size:13px; letter-spacing:.04em; text-transform:uppercase; }

  .segmented{ display:grid; grid-template-columns: repeat(3, 1fr); width:100%; padding:6px; gap:0; border-radius:14px; background:rgba(255,255,255,.50); border:2px solid rgba(0,0,0,.06); }
  .segmented button{ appearance:none; border:0; cursor:pointer; width:100%; padding:14px 0; font-weight:800; font-size:15px; color:#0f172a; background:transparent; border-radius:10px; border:2px solid transparent; transition:background .12s, transform .06s, box-shadow .12s, opacity .12s; }
  .segmented button:hover{ background:rgba(255,255,255,.35); }
  .segmented button:active{ transform:translateY(1px); }
  .segmented button.active{ background:#fff; border-color:rgba(0,0,0,.06); box-shadow:0 8px 20px rgba(0,0,0,.10); }
  .segmented button.inactive{ opacity:.55; }

  .slider-wrap{ position:relative; padding-top:14px; }
  input[type="range"]{ -webkit-appearance:none; width:100%; height:8px; border-radius:999px; background:#fff; outline:none; border:2px solid rgba(0,0,0,.07); }
  input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; width:26px; height:26px; border-radius:50%; background:#fff; border:2px solid rgba(0,0,0,.12); box-shadow:0 6px 18px rgba(0,0,0,.12); cursor:pointer; }
  input[type="range"]::-moz-range-thumb{ width:26px; height:26px; border:none; border-radius:50%; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.12); cursor:pointer; }
  .bubble{ position:absolute; top:-2px; transform:translate(-50%,-100%); background:#111827; color:#fff; padding:6px 10px; font-size:12px; border-radius:10px; box-shadow:0 10px 22px rgba(0,0,0,.14); white-space:nowrap; }
  .bubble:after{ content:""; position:absolute; left:50%; bottom:-6px; transform:translateX(-50%); border-left:6px solid transparent; border-right:6px solid transparent; border-top:6px solid #111827; }

  .switch{ display:flex; align-items:center; gap:12px; font-weight:700; }
  .switch input{ display:none; }
  .toggle{ width:54px; height:30px; border-radius:999px; background:rgba(0,0,0,.25); position:relative; cursor:pointer; }
  .toggle:after{ content:""; position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.18); transition:transform .18s ease; }
  .switch input:checked + .toggle{ background:#16a34a; }
  .switch input:checked + .toggle:after{ transform:translateX(24px); }

  .headerline{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px; }
  .title{ font-size:16px; font-weight:800; letter-spacing:.06em; text-transform:uppercase; color:#374151; }

  /* Year grid */
  .yeargrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; }
  .yearcol{ border:1px solid var(--border); border-radius:18px; padding:16px; }
  .yearhdr{ display:flex; align-items:center; justify-content:space-between; margin:4px 2px 12px; }
  .yearhdr h2{ margin:0; font-size:18px; letter-spacing:.02em; }
  .colgrid{ display:grid; grid-template-columns:1fr; gap:14px; }

  .card{ border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff; }
  .card h3{ margin:0 0 8px; font-size:13px; letter-spacing:.06em; color:#6b7280; text-transform:uppercase; }
  .metric{ display:flex; align-items:baseline; gap:10px; margin:10px 0 6px; }
  .num{ font-size:34px; font-weight:900; letter-spacing:-0.02em; }
  .badge{ padding:4px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; font-weight:800; color:#374151; }
  .tbl{ width:100%; border-collapse:collapse; font-size:14px; }
  .tbl td{ padding:8px 0; border-bottom:1px dashed var(--border); }
  .tbl td:last-child{ text-align:right; font-variant-numeric:tabular-nums; }
  .tbl tr:last-child td{ border-bottom:none; font-weight:800; }

  @media (max-width:1200px){ .wrap{ grid-template-columns:1fr; } .yeargrid{ grid-template-columns:1fr; } }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT / CONTROLS -->
    <section class="panel left" aria-label="Controls">
      <div class="lead"><h1>See how much rodents cost you</h1></div>

      <!-- Rodent Types -->
      <div class="group">
        <div class="label">Rodent Types</div>
        <div class="segmented species" role="group" aria-label="Rodent Types">
          <button type="button" class="speciesbtn active" data-id="gopher" aria-pressed="true">Gophers</button>
          <button type="button" class="speciesbtn inactive" data-id="rat" aria-pressed="false">Rats</button>
          <button type="button" class="speciesbtn inactive" data-id="squirrel" aria-pressed="false">Squirrels</button>
        </div>
      </div>

      <!-- Infestation -->
      <div class="group">
        <div class="label">Infestation Level</div>
        <div class="segmented" role="tablist" aria-label="Infestation Level">
          <button type="button" class="infbtn" data-level="1" role="tab" aria-selected="false">Mild</button>
          <button type="button" class="infbtn active" data-level="2" role="tab" aria-selected="true">Medium</button>
          <button type="button" class="infbtn" data-level="3" role="tab" aria-selected="false">Severe</button>
        </div>
      </div>

      <!-- Acres -->
      <div class="group">
        <div class="label">Acres</div>
        <div class="slider-wrap">
          <div class="bubble" id="acreBubble">40 acres</div>
          <input id="acres" type="range" min="10" max="100" step="1" value="40" aria-label="Acres" />
        </div>
      </div>

      <!-- Owl Boxes -->
      <div class="group">
        <label class="switch">
          <input id="owls" type="checkbox" aria-label="Owl Boxes" />
          <span class="toggle" aria-hidden="true"></span>
          <span>Owl Boxes</span>
        </label>
      </div>
    </section>

    <!-- RIGHT / RESULTS -->
    <section class="panel right" aria-live="polite" aria-atomic="true">
      <div class="headerline"><div class="title">3-Year Impact (Almonds)</div></div>

      <div class="yeargrid">
        <!-- YEAR 1 -->
        <div class="yearcol" id="y1">
          <div class="yearhdr"><h2>Year 1</h2></div>
          <div class="colgrid">
            <div class="card">
              <h3>Natural</h3>
              <div class="metric"><div class="num" id="y1_nat_total">$—</div><span class="badge">Total Damage</span></div>
              <table class="tbl"><tbody id="y1_nat_break"></tbody></table>
            </div>
            <div class="card">
              <h3>Treated</h3>
              <div class="metric"><div class="num" id="y1_trt_total">$—</div><span class="badge">Total Damage</span></div>
              <table class="tbl"><tbody id="y1_trt_break"></tbody></table>
            </div>
          </div>
        </div>

        <!-- YEAR 2 -->
        <div class="yearcol" id="y2">
          <div class="yearhdr"><h2>Year 2</h2></div>
          <div class="colgrid">
            <div class="card">
              <h3>Natural</h3>
              <div class="metric"><div class="num" id="y2_nat_total">$—</div><span class="badge">Total Damage</span></div>
              <table class="tbl"><tbody id="y2_nat_break"></tbody></table>
            </div>
            <div class="card">
              <h3>Treated</h3>
              <div class="metric"><div class="num" id="y2_trt_total">$—</div><span class="badge">Total Damage</span></div>
              <table class="tbl"><tbody id="y2_trt_break"></tbody></table>
            </div>
          </div>
        </div>

        <!-- YEAR 3 -->
        <div class="yearcol" id="y3">
          <div class="yearhdr"><h2>Year 3</h2></div>
          <div class="colgrid">
            <div class="card">
              <h3>Natural</h3>
              <div class="metric"><div class="num" id="y3_nat_total">$—</div><span class="badge">Total Damage</span></div>
              <table class="tbl"><tbody id="y3_nat_break"></tbody></table>
            </div>
            <div class="card">
              <h3>Treated</h3>
              <div class="metric"><div class="num" id="y3_trt_total">$—</div><span class="badge">Total Damage</span></div>
              <table class="tbl"><tbody id="y3_trt_break"></tbody></table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ------------------------------ Helpers ------------------------------ */
const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
const floorFactor=(f)=>clamp(f,0.10,5.0);          // global floor (avoid negatives / zeros)
const capOwl=(f)=>clamp(f,0.80,1.00);              // <=20% reduction per year from owls

/* ------------------------------ Model ------------------------------ */
const SPECIES = {
  gopher: { name:"Gophers", owlEffectFactor:1.0,
    K_per_acre:200, litterMean:6, birthFracFemale:.70, breederFrac:.80,
    fertSlope:1.5, survJ:.45, survS:.65, survA:.90, agingA:.02,
    basePer10:{1:20,2:40,3:70},
    pricePerLb:2.50, yieldLbPerAcre:2500,
    lossRate:{1:.02,2:.04,3:.06}, lossAfterTreat:.01,
    dripPerAcre:60, cropDmgPerAcre:40, otherPerAcre:70,
    sevMult:{1:.8,2:1.0,3:1.2}, maintMultiplierAfterTreat:.20 },
  rat: { name:"Rats", owlEffectFactor:1.0,
    K_per_acre:200, litterMean:6, birthFracFemale:.70, breederFrac:.80,
    fertSlope:1.5, survJ:.45, survS:.65, survA:.90, agingA:.02,
    basePer10:{1:20,2:40,3:70},
    pricePerLb:2.50, yieldLbPerAcre:2500,
    lossRate:{1:.02,2:.04,3:.06}, lossAfterTreat:.01,
    dripPerAcre:60, cropDmgPerAcre:40, otherPerAcre:70,
    sevMult:{1:.8,2:1.0,3:1.2}, maintMultiplierAfterTreat:.20 },
  squirrel: { name:"Squirrels", owlEffectFactor:1.0,
    K_per_acre:200, litterMean:6, birthFracFemale:.70, breederFrac:.80,
    fertSlope:1.5, survJ:.45, survS:.65, survA:.90, agingA:.02,
    basePer10:{1:20,2:40,3:70},
    pricePerLb:2.50, yieldLbPerAcre:2500,
    lossRate:{1:.02,2:.04,3:.06}, lossAfterTreat:.01,
    dripPerAcre:60, cropDmgPerAcre:40, otherPerAcre:70,
    sevMult:{1:.8,2:1.0,3:1.2}, maintMultiplierAfterTreat:.20 },
};

// Treatment (CO₂: 25% per pass, 6 passes/year)
const PASSES_PER_YEAR=6, KILL_RATE_PER_PASS=.25;
const SURVIVE_ANNUAL=Math.pow(1-KILL_RATE_PER_PASS,PASSES_PER_YEAR);

// Owls — gentle
const OWLS_PER_100_ACRES=1.9;
const PREDATION_PER_OWL_PER_WEEK=2.0;   // ↓ was 3.5
const OWL_STRENGTH=0.6;                  // ↓ was 1.8

// Owl pop-drop → damage discount (still computed, then capped)
const GAMMA=4.5, BETA_YIELD=.35, BETA_NON=.70;

// Population-linked elasticity (tempered)
const PHI_YIELD=0.6, PHI_NON=0.9;

function cloneP(P){return [[P[0][0],P[0][1]],[P[1][0],P[1][1]],[P[2][0],P[2][1]]];}
const sumAll=P=>P[0][0]+P[0][1]+P[1][0]+P[1][1]+P[2][0]+P[2][1];

function initialize(spec, acres, level){
  const totalInit=spec.basePer10[level]*(acres/10);
  const Af=totalInit*spec.birthFracFemale, Am=totalInit*(1-spec.birthFracFemale);
  return [[0,0],[0,0],[Af,Am]];
}

function annualStep(spec, P, acres, owlsOn){
  let [Jf,Jm,Sf,Sm,Af,Am]=[P[0][0],P[0][1],P[1][0],P[1][1],P[2][0],P[2][1]];
  const K_total=spec.K_per_acre*acres, total=Jf+Jm+Sf+Sm+Af+Am, density=K_total>0?total/K_total:0;
  const fertMult=1/(1+Math.exp(spec.fertSlope*(density-1)));
  const litter=spec.litterMean, breeders=Af*spec.breederFrac, births=breeders*litter*fertMult;
  const pupsF=births*spec.birthFracFemale, pupsM=births*(1-spec.birthFracFemale);
  let nextJf=pupsF, nextJm=pupsM, nextSf=Jf*spec.survJ, nextSm=Jm*spec.survJ;
  let nextAf=Sf*spec.survS+Af*spec.survA, nextAm=Sm*spec.survS+Am*spec.survA;
  nextAf=Math.max(0,nextAf - Af*spec.agingA); nextAm=Math.max(0,nextAm - Am*spec.agingA);

  if(owlsOn){
    const owlsEff=OWLS_PER_100_ACRES*(acres/100);
    const afterTot=nextJf+nextJm+nextSf+nextSm+nextAf+nextAm;
    const densityAfter=K_total>0?Math.min(1,afterTot/K_total):0;
    const owlRemoval=OWL_STRENGTH*spec.owlEffectFactor*owlsEff*PREDATION_PER_OWL_PER_WEEK*52*densityAfter;
    if(afterTot>0&&owlRemoval>0){
      const frac=Math.min(1,owlRemoval/afterTot), k=1-frac;
      nextJf*=k; nextJm*=k; nextSf*=k; nextSm*=k; nextAf*=k; nextAm*=k;
    }
  }
  return [[nextJf,nextJm],[nextSf,nextSm],[nextAf,nextAm]];
}

/* Treated scales with severity; factors floored to avoid negatives */
function damages(spec, acres, level, isTreated, factors){
  const sev    = spec.sevMult[level];
  const fYield = floorFactor((factors?.yieldFactor ?? 1.0));
  const fNon   = floorFactor((factors?.nonYieldFactor ?? 1.0));

  const baseRev = acres * spec.yieldLbPerAcre * spec.pricePerLb;
  const baseRate = isTreated ? (spec.lossAfterTreat * sev) : spec.lossRate[level];
  const lossOfCrop  = Math.max(0, baseRev * (baseRate * fYield));

  let mult = sev;
  let drip  = spec.dripPerAcre    * mult * acres;
  let cropD = spec.cropDmgPerAcre * mult * acres;
  let other = spec.otherPerAcre   * mult * acres;

  if (isTreated){
    const m = spec.maintMultiplierAfterTreat; // 20%
    drip*=m; cropD*=m; other*=m;
  }

  drip  = Math.max(0, drip  * fNon);
  cropD = Math.max(0, cropD * fNon);
  other = Math.max(0, other * fNon);

  return { lossOfCrop, drip, cropD, other, total: lossOfCrop + drip + cropD + other };
}

function addDamages(a,b){
  return {
    lossOfCrop:a.lossOfCrop+b.lossOfCrop,
    drip:a.drip+b.drip,
    cropD:a.cropD+b.cropD,
    other:a.other+b.other,
    total:a.total+b.total
  };
}

/* Simulate 3 years; damages respond to population each year */
function simulate3Years({ acres, level, owlsOn, activeIds }){
  const years = 3;
  const agg = {
    natPA_off:Array(years).fill(0), trtPA_off:Array(years).fill(0),
    natPA_on:Array(years).fill(0),  trtPA_on:Array(years).fill(0),
    dN_base:Array(years), dT_base:Array(years),
    dN_on:Array(years),   dT_on:Array(years),
  };

  activeIds.forEach(id=>{
    const spec = SPECIES[id];
    // OFF tracks
    let Pn_off = initialize(spec, acres, level);
    let Pt_off = cloneP(Pn_off);
    // ON tracks
    let Pn_on = cloneP(Pn_off);
    let Pt_on = cloneP(Pn_off);

    for(let y=0;y<years;y++){
      // ---- OFF ----
      Pn_off = annualStep(spec, Pn_off, acres, false);
      Pt_off = annualStep(spec, Pt_off, acres, false);
      for(let a=0;a<3;a++) for(let s=0;s<2;s++) Pt_off[a][s] *= SURVIVE_ANNUAL;

      const natPA_off = sumAll(Pn_off)/acres;
      const trtPA_off = sumAll(Pt_off)/acres;
      agg.natPA_off[y]+=natPA_off; agg.trtPA_off[y]+=trtPA_off;

      // ---- ON ----
      Pn_on = annualStep(spec, Pn_on, acres, true);
      Pt_on = annualStep(spec, Pt_on, acres, true);
      for(let a=0;a<3;a++) for(let s=0;s<2;s++) Pt_on[a][s] *= SURVIVE_ANNUAL;

      const natPA_on = sumAll(Pn_on)/acres;
      const trtPA_on = sumAll(Pt_on)/acres;
      agg.natPA_on[y]+=natPA_on; agg.trtPA_on[y]+=trtPA_on;
    }
  });

  // Build damages per year with population-linked factors + capped owl discounts
  for(let y=0;y<years;y++){
    const eps=1e-9;

    // Elasticity vs Year1 (OFF & ON)
    const idxN_off = Math.max(0, agg.natPA_off[y] / Math.max(eps, agg.natPA_off[0]));
    const idxT_off = Math.max(0, agg.trtPA_off[y] / Math.max(eps, agg.trtPA_off[0]));
    const idxN_on  = Math.max(0, agg.natPA_on[y]  / Math.max(eps, agg.natPA_on[0]));
    const idxT_on  = Math.max(0, agg.trtPA_on[y]  / Math.max(eps, agg.trtPA_on[0]));

    const popFacN_off = { yieldFactor: floorFactor(1 + PHI_YIELD*(idxN_off - 1)),
                          nonYieldFactor: floorFactor(1 + PHI_NON*(idxN_off - 1)) };
    const popFacT_off = { yieldFactor: floorFactor(1 + PHI_YIELD*(idxT_off - 1)),
                          nonYieldFactor: floorFactor(1 + PHI_NON*(idxT_off - 1)) };
    const popFacN_on  = { yieldFactor: floorFactor(1 + PHI_YIELD*(idxN_on - 1)),
                          nonYieldFactor: floorFactor(1 + PHI_NON*(idxN_on - 1)) };
    const popFacT_on  = { yieldFactor: floorFactor(1 + PHI_YIELD*(idxT_on - 1)),
                          nonYieldFactor: floorFactor(1 + PHI_NON*(idxT_on - 1)) };

    // Owl discount based on drop between OFF vs ON for the same year (then cap to >= 0.80)
    const rN = Math.max(0,(agg.natPA_off[y]-agg.natPA_on[y]) / Math.max(eps, agg.natPA_off[y]));
    const rT = Math.max(0,(agg.trtPA_off[y]-agg.trtPA_on[y]) / Math.max(eps, agg.trtPA_off[y]));
    const rHatN = Math.min(1, 4.5*rN);
    const rHatT = Math.min(1, 4.5*rT);
    const owlFacN = { yieldFactor: capOwl(1 - BETA_YIELD*rHatN),
                      nonYieldFactor: capOwl(1 - BETA_NON*rHatN) };
    const owlFacT = { yieldFactor: capOwl(1 - BETA_YIELD*rHatT),
                      nonYieldFactor: capOwl(1 - BETA_NON*rHatT) };

    // Combine (population elasticity × capped owl discount)
    const fN_off = popFacN_off, fT_off = popFacT_off;
    const fN_on  = { yieldFactor: floorFactor(popFacN_on.yieldFactor * owlFacN.yieldFactor),
                     nonYieldFactor: floorFactor(popFacN_on.nonYieldFactor * owlFacN.nonYieldFactor) };
    const fT_on  = { yieldFactor: floorFactor(popFacT_on.yieldFactor * owlFacT.yieldFactor),
                     nonYieldFactor: floorFactor(popFacT_on.nonYieldFactor * owlFacT.nonYieldFactor) };

    // Aggregate species damages for year y using current user selections
    let dNb=null, dTb=null, dNo=null, dTo=null;
    window._activeIdsForSim.forEach(id=>{
      const spec = SPECIES[id];
      const d1 = damages(spec, window._acresForSim, window._levelForSim, false, fN_off);
      const d2 = damages(spec, window._acresForSim, window._levelForSim, true , fT_off);
      const d3 = damages(spec, window._acresForSim, window._levelForSim, false, fN_on);
      const d4 = damages(spec, window._acresForSim, window._levelForSim, true , fT_on);
      dNb = dNb ? addDamages(dNb,d1) : d1;
      dTb = dTb ? addDamages(dTb,d2) : d2;
      dNo = dNo ? addDamages(dNo,d3) : d3;
      dTo = dTo ? addDamages(dTo,d4) : d4;
    });

    agg.dN_base[y]=dNb; agg.dT_base[y]=dTb;
    agg.dN_on[y]=dNo;   agg.dT_on[y]=dTo;
  }

  return owlsOn
    ? { dN: agg.dN_on, dT: agg.dT_on }
    : { dN: agg.dN_base, dT: agg.dT_base };
}

/* ------------------------------ UI ------------------------------ */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const acreRange=$("#acres"), acreBubble=$("#acreBubble"), owlsChk=$("#owls");
const speciesBtns=$$(".speciesbtn"), infButtons=$$(".infbtn");

function fmtMoney(n){ return "$"+Math.round(n).toLocaleString("en-US"); }

function setAcreBubble(){
  const min=+acreRange.min, max=+acreRange.max, val=+acreRange.value;
  acreBubble.textContent=`${val} acres`;
  const pct=(val-min)/(max-min), w=acreRange.clientWidth;
  acreBubble.style.left=`${pct*w}px`;
}

function activeLevel(){ const btn=infButtons.find(b=>b.classList.contains("active")); return parseInt(btn.dataset.level,10); }
function getActiveSpecies(){ const ids=speciesBtns.filter(b=>b.classList.contains("active")).map(b=>b.dataset.id); return ids.length?ids:["gopher"]; }

function fillYear(i, dN, dT){
  $("#y"+(i+1)+"_nat_total").textContent = fmtMoney(dN.total);
  $("#y"+(i+1)+"_nat_break").innerHTML = `
    <tr><td>Loss of crop</td><td>${fmtMoney(dN.lossOfCrop)}</td></tr>
    <tr><td>Drip/irrigation</td><td>${fmtMoney(dN.drip)}</td></tr>
    <tr><td>Crop damage</td><td>${fmtMoney(dN.cropD)}</td></tr>
    <tr><td>Other O&amp;M</td><td>${fmtMoney(dN.other)}</td></tr>
    <tr><td>Total</td><td>${fmtMoney(dN.total)}</td></tr>
  `;
  $("#y"+(i+1)+"_trt_total").textContent = fmtMoney(dT.total);
  $("#y"+(i+1)+"_trt_break").innerHTML = `
    <tr><td>Loss of crop</td><td>${fmtMoney(dT.lossOfCrop)}</td></tr>
    <tr><td>Drip/irrigation</td><td>${fmtMoney(dT.drip)}</td></tr>
    <tr><td>Crop damage</td><td>${fmtMoney(dT.cropD)}</td></tr>
    <tr><td>Other O&amp;M</td><td>${fmtMoney(dT.other)}</td></tr>
    <tr><td>Total</td><td>${fmtMoney(dT.total)}</td></tr>
  `;
}

function render(){
  const acres=+acreRange.value, level=activeLevel(), owlsOn=owlsChk.checked, activeIds=getActiveSpecies();
  window._acresForSim = acres;
  window._levelForSim = level;
  window._activeIdsForSim = activeIds;

  const { dN, dT } = simulate3Years({ acres, level, owlsOn, activeIds });

  [0,1,2].forEach(i => fillYear(i, dN[i], dT[i]));
}

/* Events */
$$(".infbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $$(".infbtn").forEach(b=>{ const on=(b===btn); b.classList.toggle("active",on); b.setAttribute("aria-selected",on?"true":"false"); });
    render();
  });
});
$$(".speciesbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const isActive=btn.classList.contains("active");
    btn.classList.toggle("active",!isActive);
    btn.classList.toggle("inactive",isActive);
    btn.setAttribute("aria-pressed",(!isActive).toString());
    const anyOn=$$(".speciesbtn").some(b=>b.classList.contains("active"));
    if(!anyOn){ const g=$$(".speciesbtn").find(b=>b.dataset.id==="gopher"); g.classList.add("active"); g.classList.remove("inactive"); g.setAttribute("aria-pressed","true"); }
    render();
  });
});
acreRange.addEventListener("input", ()=>{ setAcreBubble(); render(); });
$("#owls").addEventListener("change", render);
window.addEventListener("load", ()=>{ setAcreBubble(); render(); window.addEventListener("resize", setAcreBubble); });
</script>
</body>
</html>
